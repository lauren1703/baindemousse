{% extends "ecommerce/base.html" %}
{% load static %}
{% block title %}Your Cart{% endblock %}

{% block content %}
<div class="cart">
    <!--header-->
    <div class="position-relative">
        <div class="header-container"></div>
        <img class="wave-img" src="{% static 'ecommerce/images/icons/wave 9.png' %}" alt="wave">
        <div class="header-text container-fluid d-flex flex-column justify-content-center gap-3">
            <div class="d-flex justify-content-around">
                <h4 class="">1. Shopping Cart</h2>
                <h4 class="d-none d-md-block">2. Shipping Details</h2>
                <h4 class="d-none d-md-block">3. Payment Options</h2>
            </div>
            <div class="d-flex justify-content-center">
                <div class="separator-bold"></div>
                <div class="separator-header d-none d-md-block"></div>
            </div>
        </div>
    </div>
    <!--content-->
    <div class="info container-fluid row content mt-4 mx-1">
        <!--cart details-->
        <div class="details col-md-7 col-md d-flex flex-column gap-2">
            <div class="d-flex justify-content-start">
                <h2>Shopping Cart</h2>
            </div>
            <div class="separator separator-cart"></div>
            <div class="summary-products d-flex flex-column">
                {% for item in cart %}
                {% with product=item.product %}
                <div data-index="{{product.id}}" class="product d-flex justify-content-between align-items-center">
                    <a href="{{ product.get_absolute_url }}">
                        <div class="d-flex align-items-center">
                            <div class="product-img-container d-flex">
                                <img class="product-img" src="{% get_static_prefix %}ecommerce/images/products/{{ product.title }}.png" alt="product">
                            </div>
                            <div class="product-info d-flex flex-column justify-content-center">
                                <p>{{ product.title }}</p>
                                <p>${{ product.price }}</p>
                            </div>
                        </div>
                    </a>
                    <div class="edit-product d-flex flex-column justify-content-center align-items-center">
                        <div class="select-quantity gap-3">
                            <select class="form-select text-center" id="select{{product.id}}">
                                <option selected>
                                    {{item.qty}}
                                </option>
                                <option class="bg-white" value="1">1</option>
                                <option class="bg-white" value="2">2</option>
                                <option class="bg-white" value="3">3</option>
                                <option class="bg-white" value="4">4</option>
                                </select>
                        </div>
                        <button type="button" class="" id="delete-btn" data-index="{{product.id}}"><img class="delete-img" src="{% static 'ecommerce/images/icons/delete.png' %}"></a>
                        <button type="button" class="btn outline-btn save-changes" id="update-btn" data-index="{{product.id}}">Update</a>
                    </div>
                    
                </div>
                {% endwith %}
                {% endfor %}
                
            </div>
            <div class="separator separator-cart"></div>
        </div>
        <!--summary-->
        <div class="summary col-md-5 d-flex justify-content-center mt-5 mt-md-0">
            <div class="summary-bg bg-white p-5">
                <div class="summary-container d-flex flex-column gap-2">
                    <div class="d-flex justify-content-start">
                        <h2>Summary</h2>
                    </div>
                    <div class="separator separator-summary"></div>
                    <div class="d-flex justify-content-between">
                        <p class="text">SUBTOTAL</p>
                        <p>$<span class="text" id="subtotal">{{cart.get_subtotal_price}}</span></p>
                    </div>
                    <div class="d-flex justify-content-between">
                        <p class="text">SHIPPING</p>
                        <p class="text">CALCULATED AT NEXT STEP</p>
                    </div>
                    <div class="separator separator-summary"></div>
                    <div class="d-flex justify-content-between">
                        <p class="text">TOTAL</p>
                        <p class="text">CALCULATED AT NEXT STEP</p>
                    </div>
                    <div class="d-flex justify-content-center mt-3">
                        <div class="charity-text d-flex align-items-center p-3">
                            <p class="lead text-center m-auto">$<span id="charity-total">{{cart.get_charity_subtotal}}</span> of your order goes to helping transform children's lives with safe water!</p>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
        <div class="buttons d-flex">
            <a class="btn outline-btn btn-continue" href="{% url "ecommerce:all_view" %}">Continue Shopping</a>
            <a class="btn btn-gradient btn-continue bg-purple" href="{% url "payment:shipping_view" %}">Continue To Shipping</a>
        </div>
    </div>
</div>

<script>
    //Delete item
    $(document).on('click', '#delete-btn', function (e) {
        e.preventDefault();
        var prodid = $(this).data('index');
        $.ajax({
            type: 'POST',
            url: '{% url "cart:cart_delete" %}',
            data: {
                productid: $(this).data('index'),
                csrfmiddlewaretoken: "{{ csrf_token }}",
                action: 'post'
            },
            success: function (json) {
                $('.product[data-index="'+ prodid +'"]').remove();
                document.getElementById("cart-qty").innerHTML = json.qty
                document.getElementById("subtotal").innerHTML = json.subtotal
                document.getElementById("charity-total").innerHTML = json.charitytotal
            },
            error: function (xhr, errmsg, err) {
                alert(errmsg);
            }
        });
    });

    //Update item
    $(document).on('click', '#update-btn', function (e) {
        e.preventDefault();
        var prodid = $(this).data('index');
        $.ajax({
            type: 'POST',
            url: '{% url "cart:cart_update" %}',
            data: {
                productid: $(this).data('index'),
                productqty: $('#select'+ prodid + ' option:selected').text(),
                csrfmiddlewaretoken: "{{ csrf_token }}",
                action: 'post'
            },
            success: function (json) {
                document.getElementById("cart-qty").innerHTML = json.qty
                document.getElementById("subtotal").innerHTML = json.subtotal
                document.getElementById("charity-total").innerHTML = json.charitytotal
            },
            error: function (xhr, errmsg, err) {
            }
        });
    });
</script>

{% endblock %}